<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>LED Matrix Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #181828;
      color: #fff;
      font-family: Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .container {
      max-width: 100vw;
      min-height: 100vh;
      margin: 0 auto;
      background: #232346;
      border-radius: 0;
      padding: 1em 0.5em 2em 0.5em;
      box-shadow: none;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
      margin: 0.5em 0 1em 0;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #444;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab {
      flex: 1 1 0;
      padding: 0.7em 0.2em;
      cursor: pointer;
      border: none;
      background: none;
      color: #fff;
      font-size: 1em;
      min-width: 100px;
      text-align: center;
      transition: color 0.2s, box-shadow 0.1s, transform 0.1s;
      outline: none;
      user-select: none;
    }
    .tab.active {
      border-bottom: 3px solid #8e44ad;
      color: #8e44ad;
      font-weight: bold;
    }
    /* Визуализация нажатия для .tab */
    .tab:active {
      color: #a370d9;
      transform: translateY(2px);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    }

    .tab-content {
      margin-top: 1.2em;
      padding: 0 0.3em;
    }
    .setting {
      margin-bottom: 1.2em;
    }
    .setting label {
      display: block;
      margin-bottom: 0.4em;
      font-size: 1em;
    }
    .slider {
      width: 90vw;
      max-width: 350px;
      margin: 0.3em 0;
      height: 32px;
      touch-action: pan-x;
    }
    .color-input {
      width: 48px;
      height: 32px;
      border: none;
      border-radius: 4px;
      vertical-align: middle;
      margin-left: 0.7em;
      background: #fff;
      padding: 0;
    }
    .reset-btn {
      margin-top: 1.5em;
      background: #e74c3c;
      color: #fff;
      border: none;
      padding: 1em 2em;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      width: 100%;
      max-width: 350px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      transition: background 0.15s, box-shadow 0.1s, transform 0.1s;
      user-select: none;
    }
    .reset-btn:hover, .reset-btn:active {
      background: #c0392b;
    }
    /* Визуализация нажатия для reset-btn */
    .reset-btn:active {
      transform: translateY(2px);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.6);
    }

    .select, input[type="number"] {
      padding: 0.5em;
      border-radius: 4px;
      border: 1px solid #444;
      background: #232346;
      color: #fff;
      font-size: 1em;
      width: 100%;
      max-width: 180px;
      box-sizing: border-box;
      margin-top: 0.3em;
    }
    .anim-tabs {
      display: flex;
      gap: 0.5em;
      margin-bottom: 1em;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;        /* Firefox */
    }
    .anim-tabs::-webkit-scrollbar {  /* Chrome, Safari */
      display: none;
    }
    .anim-tab {
      flex: 0 0 auto;
      min-width: 120px;
      max-width: 200px;
      padding: 0.5em 1em;
      border-radius: 6px 6px 0 0;
      background: #232346;
      color: #fff;
      cursor: pointer;
      border: 1px solid #444;
      border-bottom: none;
      font-size: 1em;
      text-align: center;
      outline: none;
      white-space: nowrap;
      transition: background 0.15s, box-shadow 0.1s, transform 0.1s;
      user-select: none;
    }
    .anim-tab.active {
      background: #8e44ad;
      color: #fff;
      font-weight: bold;
    }
    /* Визуализация нажатия для .anim-tab */
    .anim-tab:active {
      background: #a370d9;
      transform: translateY(2px);
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
    }

    .anim-tabs-bar {
      width: 100%;
      height: 2px;
      background: #444;
      border-radius: 0;
      position: relative;
      top: 0;
      margin: 0 0 1.2em 0; /* нижний отступ между полосой и параметрами */
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.1em; }
      .container { padding: 0.5em 0.1em 1em 0.1em; }
      .slider { max-width: 98vw; }
      .reset-btn { font-size: 1em; padding: 0.7em 0.5em; }
      .anim-tab, .tab { font-size: 0.95em; min-width: 80px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LED Matrix Control Panel</h1>
    <div class="tabs" id="tabs"></div>
    <div class="tab-content" id="tab-content"></div>
    <button class="reset-btn" onclick="resetAll()">Сбросить все настройки</button>
  </div>
  <script>
    let config = {};
    let currentTab = 'animator';
    let currentAnim = '';
    let animTypes = [];

    async function fetchConfig() {
      const res = await fetch('/api/config');
      config = await res.json();
      renderTabs();
      renderTabContent();
    }
    function renderTabs() {
      const tabs = [
        { key: 'animator', label: 'Анимации' },
        { key: 'ledMatrix', label: 'Матрица' },
        { key: 'audioAnalyzer', label: 'Аудиоанализатор' }
      ];
      document.getElementById('tabs').innerHTML = tabs.map(tab =>
        `<button class="tab${currentTab === tab.key ? ' active' : ''}" onclick="switchTab('${tab.key}')">${tab.label}</button>`
      ).join('');
    }
    function switchTab(tab) {
      currentTab = tab;
      renderTabs();
      renderTabContent();
    }
    function switchAnim(animType) {
      config.animator.currentAnimationType = animType;
      currentAnim = animType;
      updateConfig('animator', { currentAnimationType: animType });
      renderTabContent();
    }
    function renderTabContent() {
      if (!config.animator) return;
      if (currentTab === 'animator') {
        animTypes = config.animator.animations.map(a => a.type);
        if (!currentAnim) currentAnim = config.animator.currentAnimationType || animTypes[0];
        let anim = config.animator.animations.find(a => a.type === currentAnim) || config.animator.animations[0];
        let animTabs = `<div class="anim-tabs">` +
          config.animator.animations.map(a =>
            `<div class="anim-tab${a.type === currentAnim ? ' active' : ''}" onclick="switchAnim('${a.type}')">${a.moduleLabel}</div>`
          ).join('') + `</div><div class="anim-tabs-bar"></div>`;
        let settingsHtml = renderSettingsForm(anim.settings, 'animator', anim.moduleName);
        let resetHtml = `<button class="reset-btn" onclick="resetAnimation('${anim.moduleName}')">Сбросить настройки анимации</button>`;
        document.getElementById('tab-content').innerHTML = animTabs + settingsHtml + resetHtml;
      } else if (currentTab === 'ledMatrix') {
        let html = renderSettingsForm(config.ledMatrix.settings, 'ledMatrix', '');
        html += `<button class="reset-btn" onclick="resetModule('ledMatrix')">Сбросить настройки матрицы</button>`;
        document.getElementById('tab-content').innerHTML = html;
      } else if (currentTab === 'audioAnalyzer') {
        let html = renderSettingsForm(config.audioAnalyzer.settings, 'audioAnalyzer', '');
        html += `<button class="reset-btn" onclick="resetModule('audioAnalyzer')">Сбросить настройки аудиоанализа</button>`;
        document.getElementById('tab-content').innerHTML = html;
      }
    }
    function renderSettingsForm(settings, moduleKey, animModuleName) {
      if (!settings) return '<p>Нет настроек.</p>';
      return settings.map(s => {
        let id = `${moduleKey}-${animModuleName}-${s.key}`;
        if (s.type === 'number') {
          return `
          <div class="setting">
            <label for="${id}">${s.label} (${s.min}..${s.max})</label>
            <input type="range" id="${id}" min="${s.min}" max="${s.max}" step="${s.step || 1}" value="${s.value}"
              class="slider"
              onchange="updateSetting('${moduleKey}', '${animModuleName}', '${s.key}', this.value)" />
            <input type="number" min="${s.min}" max="${s.max}" step="${s.step || 1}" value="${s.value}" 
              style="width: 60px; margin-left: 0.7em;"
              onchange="updateSetting('${moduleKey}', '${animModuleName}', '${s.key}', this.value)" />
          </div>`;
        } else if (s.type === 'color') {
          return `
          <div class="setting">
            <label for="${id}">${s.label}</label>
            <input type="color" id="${id}" value="${s.value}" class="color-input" 
              onchange="updateSetting('${moduleKey}', '${animModuleName}', '${s.key}', this.value)" />
          </div>`;
        } else if (s.type === 'select') {
          let optionsHtml = s.options.map(o =>
            `<option value="${o.value}"${o.value === s.value ? ' selected' : ''}>${o.label}</option>`).join('');
          return `
          <div class="setting">
            <label for="${id}">${s.label}</label>
            <select id="${id}" class="select" onchange="updateSetting('${moduleKey}', '${animModuleName}', '${s.key}', this.value)">
              ${optionsHtml}
            </select>
          </div>`;
        } else {
          return '';
        }
      }).join('');
    }
    function updateSetting(moduleKey, animModuleName, key, value) {
      value = normalizeValue(value);
      if (moduleKey === 'animator' && animModuleName) {
        let anim = config.animator.animations.find(a => a.moduleName === animModuleName);
        if (anim) {
          let setting = anim.settings.find(s => s.key === key);
          if (setting) {
            setting.value = value;
            updateConfig(moduleKey, {[animModuleName]: anim.settings});
          }
        }
      } else {
        let modSettings = config[moduleKey]?.settings;
        if (modSettings) {
          let setting = modSettings.find(s => s.key === key);
          if (setting) {
            setting.value = value;
            updateConfig(moduleKey, {settings: modSettings});
          }
        }
      }
    }
    function normalizeValue(value) {
      if (typeof value === 'string') {
        if (!isNaN(value)) {
          return Number(value);
        }
        return value;
      }
      return value;
    }
    async function updateConfig(moduleKey, data) {
      await fetch(`/api/config/${moduleKey}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
    }
    async function resetModule(moduleKey) {
      if (!confirm(`Сбросить настройки модуля "${moduleKey}" к значениям по умолчанию?`)) return;
      await fetch(`/api/config/${moduleKey}/reset`, { method: 'POST' });
      await fetchConfig();
    }
    async function resetAnimation(animModuleName) {
      if (!confirm(`Сбросить настройки анимации "${animModuleName}" к значениям по умолчанию?`)) return;
      await fetch(`/api/config/animator/reset/${animModuleName}`, { method: 'POST' });
      await fetchConfig();
    }
    async function resetAll() {
      if (!confirm('Сбросить все настройки к значениям по умолчанию?')) return;
      await fetch(`/api/config/reset`, { method: 'POST' });
      await fetchConfig();
    }
    fetchConfig();
  </script>
</body>
</html>

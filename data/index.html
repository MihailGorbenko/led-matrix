<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>LED Matrix Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #181828;
      color: #fff;
      font-family: Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    .container {
      max-width: 100vw;
      min-height: 100vh;
      margin: 0 auto;
      background: #232346;
      border-radius: 0;
      padding: 1em 0.5em 2em 0.5em;
      box-shadow: none;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
      margin: 0.5em 0 1em 0;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #444;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab {
      flex: 1 1 0;
      padding: 0.7em 0.2em;
      cursor: pointer;
      border: none;
      background: none;
      color: #fff;
      font-size: 1em;
      min-width: 100px;
      text-align: center;
      transition: color 0.2s;
      outline: none;
    }
    .tab.active {
      border-bottom: 3px solid #8e44ad;
      color: #8e44ad;
      font-weight: bold;
    }
    .tab-content {
      margin-top: 1.2em;
      padding: 0 0.3em;
    }
    .setting {
      margin-bottom: 1.2em;
    }
    .setting label {
      display: block;
      margin-bottom: 0.4em;
      font-size: 1em;
    }
    .slider {
      width: 90vw;
      max-width: 350px;
      margin: 0.3em 0;
      height: 32px;
      touch-action: pan-x;
    }
    .color-input {
      width: 48px;
      height: 32px;
      border: none;
      border-radius: 4px;
      vertical-align: middle;
      margin-left: 0.7em;
      background: #fff;
      padding: 0;
    }
    .reset-btn {
      margin-top: 1.5em;
      background: #e74c3c;
      color: #fff;
      border: none;
      padding: 1em 2em;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1em;
      width: 100%;
      max-width: 350px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .reset-btn:hover, .reset-btn:active {
      background: #c0392b;
    }
    .select, input[type="number"] {
      padding: 0.5em;
      border-radius: 4px;
      border: 1px solid #444;
      background: #232346;
      color: #fff;
      font-size: 1em;
      width: 100%;
      max-width: 180px;
      box-sizing: border-box;
      margin-top: 0.3em;
    }
    .anim-tabs {
      display: flex;
      gap: 0.5em;
      margin-bottom: 1em;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .anim-tab {
      padding: 0.5em 1em;
      border-radius: 6px 6px 0 0;
      background: #232346;
      color: #fff;
      cursor: pointer;
      border: 1px solid #444;
      border-bottom: none;
      font-size: 1em;
      min-width: 100px;
      text-align: center;
      flex: 1 1 0;
      outline: none;
    }
    .anim-tab.active {
      background: #8e44ad;
      color: #fff;
      font-weight: bold;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.1em; }
      .container { padding: 0.5em 0.1em 1em 0.1em; }
      .slider { max-width: 98vw; }
      .reset-btn { font-size: 1em; padding: 0.7em 0.5em; }
      .anim-tab, .tab { font-size: 0.95em; min-width: 80px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LED Matrix Control Panel</h1>
    <div class="tabs" id="tabs"></div>
    <div class="tab-content" id="tab-content"></div>
    <button class="reset-btn" onclick="resetAll()">Сбросить все настройки</button>
  </div>
  <script>
    let config = {};
    let currentTab = 'animator';
    let currentAnim = '';
    let animTypes = [];

    async function fetchConfig() {
      const res = await fetch('/api/config');
      config = await res.json();
      renderTabs();
      renderTabContent();
    }
    function renderTabs() {
      const tabs = [
        { key: 'animator', label: 'Анимации' },
        { key: 'ledMatrix', label: 'Матрица' },
        { key: 'audioAnalyzer', label: 'Аудиоанализатор' }
      ];
      document.getElementById('tabs').innerHTML = tabs.map(tab =>
        `<button class="tab${currentTab === tab.key ? ' active' : ''}" onclick="switchTab('${tab.key}')">${tab.label}</button>`
      ).join('');
    }
    function switchTab(tab) {
      currentTab = tab;
      renderTabs();
      renderTabContent();
    }
    function switchAnim(animType) {
      config.animator.currentAnimationType = animType;
      currentAnim = animType;
      updateConfig('animator', { currentAnimationType: animType });
      renderTabContent();
    }
    function renderTabContent() {
      if (!config.animator) return;
      if (currentTab === 'animator') {
        animTypes = config.animator.animations.map(a => a.type);
        if (!currentAnim) currentAnim = config.animator.currentAnimationType || animTypes[0];
        let anim = config.animator.animations.find(a => a.type === currentAnim) || config.animator.animations[0];
        let animTabs = `<div class="anim-tabs">` +
          config.animator.animations.map(a =>
            `<div class="anim-tab${a.type === currentAnim ? ' active' : ''}" onclick="switchAnim('${a.type}')">${a.moduleLabel}</div>`
          ).join('') + `</div>`;
        let settingsHtml = renderSettingsForm(anim.settings, 'animator', anim.moduleName);
        let resetBtn = `<button class="reset-btn" style="background:#8e44ad" onclick="resetAnimation('${anim.moduleName}')">Сбросить настройки анимации</button>`;
        document.getElementById('tab-content').innerHTML = animTabs + settingsHtml + resetBtn;
      } else if (currentTab === 'ledMatrix') {
        document.getElementById('tab-content').innerHTML =
          renderSettingsForm(config.ledMatrix.settings, 'ledMatrix') +
          `<button class="reset-btn" style="background:#2980b9" onclick="resetLedMatrix()">Сбросить настройки матрицы</button>`;
      } else if (currentTab === 'audioAnalyzer') {
        document.getElementById('tab-content').innerHTML =
          renderSettingsForm(config.audioAnalyzer.settings, 'audioAnalyzer') +
          `<button class="reset-btn" style="background:#16a085" onclick="resetAudioAnalyzer()">Сбросить настройки аудиоанализатора</button>`;
      }
    }
    function renderSettingsForm(settings, module, animName) {
      if (!settings) return '';
      return settings.map(setting => {
        let val = setting.value;
        let id = `${module}_${animName || ''}_${setting.name}`;
        // Красивое горизонтальное выравнивание label и color picker
        if (
          (setting.name.toLowerCase().includes('color') || setting.label.toLowerCase().includes('цвет')) &&
          setting.type === 'int'
        ) {
          return `<div class="setting" style="display:flex;align-items:center;gap:1em;">
            <label for="${id}" style="font-size:1.1em;flex:1 1 0;">${setting.label}</label>
            <input type="color" id="${id}" class="color-input" style="width:60px;height:40px;flex-shrink:0;" value="#${val.toString(16).padStart(6, '0')}" onchange="onColorChange('${module}','${animName}','${setting.name}',this.value)">
          </div>`;
        } else if (setting.type === 'int' || setting.type === 'float') {
          return `<div class="setting">
            <label for="${id}">${setting.label}: <span id="${id}_val">${val}</span></label>
            <input type="range" id="${id}" class="slider" min="${setting.min}" max="${setting.max}" step="${setting.step}" value="${val}"
              oninput="document.getElementById('${id}_val').innerText=this.value"
              onchange="onSliderChange('${module}','${animName}','${setting.name}',this.value)">
          </div>`;
        }
        return '';
      }).join('');
    }
    async function onColorChange(module, animName, name, value) {
      let intVal = parseInt(value.replace('#',''), 16);
      let payload = {};
      if (module === 'animator') {
        payload[module] = {};
        payload[module][animName] = { [name]: { value: intVal } };
      } else {
        payload[module] = { [name]: { value: intVal } };
      }
      await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      fetchConfig();
    }
    async function onSliderChange(module, animName, name, value) {
      let numVal = Number(value);
      let payload = {};
      if (module === 'animator') {
        payload[module] = {};
        payload[module][animName] = { [name]: { value: numVal } };
      } else {
        payload[module] = { [name]: { value: numVal } };
      }
      await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      fetchConfig();
    }
    async function resetAll() {
      await fetch('/api/reset', { method: 'POST' });
      fetchConfig();
    }
    async function resetAnimation(name) {
      await fetch('/api/reset/animation?name=' + encodeURIComponent(name), { method: 'POST' });
      fetchConfig();
    }
    async function resetLedMatrix() {
      await fetch('/api/reset/ledMatrix', { method: 'POST' });
      fetchConfig();
    }
    async function resetAudioAnalyzer() {
      await fetch('/api/reset/audioAnalyzer', { method: 'POST' });
      fetchConfig();
    }
    async function updateConfig(module, data) {
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ [module]: data })
      });
      fetchConfig();
    }
    window.switchTab = switchTab;
    window.switchAnim = switchAnim;
    window.onColorChange = onColorChange;
    window.onSliderChange = onSliderChange;
    window.resetAll = resetAll;
    window.resetAnimation = resetAnimation;
    window.resetLedMatrix = resetLedMatrix;
    window.resetAudioAnalyzer = resetAudioAnalyzer;

    fetchConfig();
  </script>
</body>
</html>